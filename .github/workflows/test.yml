name: Run Tests and Linting

on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]

env:
  PYTHON_VERSION: '3.11'

jobs:
  test:
    runs-on: ubuntu-latest
    env:
      DATABASE_URL: "postgresql+asyncpg://user:password@db:5432/crm_db"
      SECRET_KEY: "test-secret-key"
      TESTING: "true"

    steps:
    - uses: actions/checkout@v4

    - name: Set up Python ${{ env.PYTHON_VERSION }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}

    - name: Install Python dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements_dev.txt

    - name: Start test containers
      run: |
        docker compose up -d

    - name: Wait for PostgreSQL to be ready
      run: |
        timeout 60s bash -c 'until docker compose exec -T db pg_isready -U user -d crm_db; do sleep 2; done'

    - name: Wait for Redis to be ready
      run: |
        timeout 30s bash -c 'until docker compose exec -T redis redis-cli ping | grep -q PONG; do sleep 2; done'

    - name: Check containers status
      run: |
        docker compose ps

    - name: Run tests with script
      run: |
        chmod +x run_tests.sh
        ./run_tests.sh
      env:
        TESTING: ${{ env.TESTING }}
        TEST_DATABASE_URL: ${{ env.DATABASE_URL }}
        SECRET_KEY: ${{ env.SECRET_KEY }}
        REDIS_URL: redis://localhost:6379

    - name: Stop containers
      if: always()
      run: |
        docker compose down

  lint:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4

    - name: Set up Python ${{ env.PYTHON_VERSION }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}

    - name: Install Python dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements_dev.txt

    - name: Run linters
      run: |
        chmod +x run_linters.sh
        ./run_linters.sh